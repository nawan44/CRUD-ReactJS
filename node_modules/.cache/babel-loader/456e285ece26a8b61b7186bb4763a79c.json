{"ast":null,"code":"var fs = require('fs');\n\nvar path = require('path');\n\nvar walk = require('walk').walk;\n\nvar async = require('./async');\n\nfunction Instance(handlebars) {\n  if (!(this instanceof Instance)) {\n    return new Instance(handlebars);\n  } // expose handlebars, allows users to use their versions\n  // by overriding this early in their apps\n\n\n  var self = this;\n  self.handlebars = handlebars || require('handlebars').create(); // cache for templates, express 3.x doesn't do this for us\n\n  self.cache = {};\n  self.__express = middleware.bind(this); // DEPRECATED, kept for backwards compatibility\n\n  self.SafeString = this.handlebars.SafeString;\n  self.Utils = this.handlebars.Utils;\n}\n\n; // express 3.x template engine compliance\n\nfunction middleware(filename, options, cb) {\n  var self = this;\n  var cache = self.cache;\n  var handlebars = self.handlebars;\n  self.async = async(); // grab extension from filename\n  // if we need a layout, we will look for one matching out extension\n\n  var extension = path.extname(filename); // Default handlebars runtime options\n\n  var handlebarsOpts = {\n    allowProtoMethodsByDefault: true,\n    allowProtoPropertiesByDefault: true\n  }; // If passing the locals as data, create the handlebars options object now\n\n  if (self.__localsAsData) {\n    handlebarsOpts.data = options._locals;\n  } // render the original file\n  // cb(err, str)\n\n\n  function render_file(locals, cb) {\n    // cached?\n    var template = cache[filename];\n\n    if (template) {\n      try {\n        var res = template(locals, handlebarsOpts);\n        self.async.done(function (values) {\n          Object.keys(values).forEach(function (id) {\n            res = res.replace(id, values[id]);\n          });\n          cb(null, res);\n        });\n      } catch (err) {\n        cb(prependFilenameToError(filename, err));\n      }\n\n      return;\n    }\n\n    fs.readFile(filename, 'utf8', function (err, str) {\n      if (err) {\n        return cb(err);\n      }\n\n      var template = handlebars.compile(str);\n\n      if (locals.cache) {\n        cache[filename] = template;\n      }\n\n      try {\n        var res = template(locals, handlebarsOpts);\n        self.async.done(function (values) {\n          Object.keys(values).forEach(function (id) {\n            res = res.replace(id, values[id]);\n          });\n          cb(null, res);\n        });\n      } catch (err) {\n        cb(prependFilenameToError(filename, err));\n      }\n    });\n  } // render with a layout\n\n\n  function render_with_layout(filename, template, locals, cb) {\n    render_file(locals, function (err, str) {\n      if (err) {\n        return cb(err);\n      }\n\n      locals.body = str;\n\n      try {\n        var res = template(locals, handlebarsOpts);\n        self.async.done(function (values) {\n          Object.keys(values).forEach(function (id) {\n            res = res.replace(id, values[id]);\n          });\n          cb(null, res);\n        });\n      } catch (err) {\n        cb(prependFilenameToError(filename, err));\n      }\n    });\n  }\n\n  var layout = options.layout; // user did not specify a layout in the locals\n  // check global layout state\n\n  if (layout === undefined && options.settings && options.settings['view options']) {\n    layout = options.settings['view options'].layout;\n  } // user explicitly request no layout\n  // either by specifying false for layout: false in locals\n  // or by settings the false view options\n\n\n  if (layout !== undefined && !layout) {\n    return render_file(options, cb);\n  }\n\n  var view_dirs = options.settings.views;\n  var layout_filename = [].concat(view_dirs).map(function (view_dir) {\n    var view_path = path.join(view_dir, layout || 'layout');\n\n    if (!path.extname(view_path)) {\n      view_path += extension;\n    }\n\n    return view_path;\n  });\n\n  for (var i = 0; i < layout_filename.length; i++) {\n    var layout_template = cache[layout_filename[i]];\n\n    if (layout_template) {\n      return render_with_layout(layout_filename[i], layout_template, options, cb);\n    }\n  } // TODO check if layout path has .hbs extension\n\n\n  function prependFilenameToError(filename, err) {\n    // prepend to the message\n    if (typeof err.message === 'string') {\n      err.message = filename + ': ' + err.message;\n    }\n\n    return err;\n  }\n\n  function cacheAndCompile(filename, str) {\n    var layout_template = handlebars.compile(str);\n\n    if (options.cache) {\n      cache[filename] = layout_template;\n    }\n\n    render_with_layout(filename, layout_template, options, cb);\n  }\n\n  function tryReadFileAndCache(templates) {\n    var template = templates.shift();\n    fs.readFile(template, 'utf8', function (err, str) {\n      if (err) {\n        if (layout && templates.length === 0) {\n          // Only return error if user explicitly asked for layout.\n          return cb(err);\n        }\n\n        if (templates.length > 0) {\n          return tryReadFileAndCache(templates);\n        }\n\n        return render_file(options, cb);\n      }\n\n      cacheAndCompile(template, str);\n    });\n  }\n\n  tryReadFileAndCache(layout_filename);\n} // express 2.x template engine compliance\n\n\nInstance.prototype.compile = function (str) {\n  if (typeof str !== 'string') {\n    return str;\n  }\n\n  var template = this.handlebars.compile(str);\n  return function (locals) {\n    return template(locals, {\n      helpers: locals.blockHelpers,\n      partials: null,\n      data: null\n    });\n  };\n};\n\nInstance.prototype.registerHelper = function () {\n  this.handlebars.registerHelper.apply(this.handlebars, arguments);\n};\n\nInstance.prototype.registerPartial = function () {\n  this.handlebars.registerPartial.apply(this.handlebars, arguments);\n};\n\nInstance.prototype.registerPartials = function (directory, done) {\n  var handlebars = this.handlebars;\n\n  var register = function (filepath, done) {\n    var isValidTemplate = /\\.(html|hbs)$/.test(filepath);\n\n    if (!isValidTemplate) {\n      return done(null);\n    }\n\n    fs.readFile(filepath, 'utf8', function (err, data) {\n      if (!err) {\n        var ext = path.extname(filepath);\n        var templateName = path.relative(directory, filepath).slice(0, -ext.length).replace(/[ -]/g, '_').replace(/\\\\/g, '/');\n        handlebars.registerPartial(templateName, data);\n      }\n\n      done(err);\n    });\n  };\n\n  walk(directory).on('file', function (root, stat, next) {\n    register(path.join(root, stat.name), next);\n  }).on('end', done || function () {});\n};\n\nInstance.prototype.registerAsyncHelper = function (name, fn) {\n  var self = this;\n  self.handlebars.registerHelper(name, function () {\n    return self.async.resolve(fn, arguments);\n  });\n};\n\nInstance.prototype.localsAsTemplateData = function (app) {\n  // Set a flag to indicate we should pass locals as data\n  this.__localsAsData = true;\n\n  app.render = function (render) {\n    return function (view, options, callback) {\n      if (typeof options === \"function\") {\n        callback = options;\n        options = {};\n      } // Mix response.locals (options._locals) with app.locals (this.locals)\n\n\n      options._locals = options._locals || {};\n\n      for (var key in this.locals) {\n        options._locals[key] = this.locals[key];\n      }\n\n      return render.call(this, view, options, callback);\n    };\n  }(app.render);\n};\n\nmodule.exports = new Instance();\n\nmodule.exports.create = function (handlebars) {\n  return new Instance(handlebars);\n};","map":{"version":3,"sources":["/home/nawan44/Documents/github/portofolio/CRUD/node_modules/hbs/lib/hbs.js"],"names":["fs","require","path","walk","async","Instance","handlebars","self","create","cache","__express","middleware","bind","SafeString","Utils","filename","options","cb","extension","extname","handlebarsOpts","allowProtoMethodsByDefault","allowProtoPropertiesByDefault","__localsAsData","data","_locals","render_file","locals","template","res","done","values","Object","keys","forEach","id","replace","err","prependFilenameToError","readFile","str","compile","render_with_layout","body","layout","undefined","settings","view_dirs","views","layout_filename","concat","map","view_dir","view_path","join","i","length","layout_template","message","cacheAndCompile","tryReadFileAndCache","templates","shift","prototype","helpers","blockHelpers","partials","registerHelper","apply","arguments","registerPartial","registerPartials","directory","register","filepath","isValidTemplate","test","ext","templateName","relative","slice","on","root","stat","next","name","registerAsyncHelper","fn","resolve","localsAsTemplateData","app","render","view","callback","key","call","module","exports"],"mappings":"AAAA,IAAIA,EAAE,GAAGC,OAAO,CAAC,IAAD,CAAhB;;AACA,IAAIC,IAAI,GAAGD,OAAO,CAAC,MAAD,CAAlB;;AACA,IAAIE,IAAI,GAAGF,OAAO,CAAC,MAAD,CAAP,CAAgBE,IAA3B;;AAEA,IAAIC,KAAK,GAAGH,OAAO,CAAC,SAAD,CAAnB;;AAEA,SAASI,QAAT,CAAkBC,UAAlB,EAA8B;AAC5B,MAAI,EAAE,gBAAgBD,QAAlB,CAAJ,EAAiC;AAC/B,WAAO,IAAIA,QAAJ,CAAaC,UAAb,CAAP;AACD,GAH2B,CAK5B;AACA;;;AACA,MAAIC,IAAI,GAAG,IAAX;AAEAA,EAAAA,IAAI,CAACD,UAAL,GAAkBA,UAAU,IAAIL,OAAO,CAAC,YAAD,CAAP,CAAsBO,MAAtB,EAAhC,CAT4B,CAW5B;;AACAD,EAAAA,IAAI,CAACE,KAAL,GAAa,EAAb;AAEAF,EAAAA,IAAI,CAACG,SAAL,GAAiBC,UAAU,CAACC,IAAX,CAAgB,IAAhB,CAAjB,CAd4B,CAgB5B;;AACAL,EAAAA,IAAI,CAACM,UAAL,GAAkB,KAAKP,UAAL,CAAgBO,UAAlC;AACAN,EAAAA,IAAI,CAACO,KAAL,GAAa,KAAKR,UAAL,CAAgBQ,KAA7B;AACD;;AAAA,C,CAED;;AACA,SAASH,UAAT,CAAoBI,QAApB,EAA8BC,OAA9B,EAAuCC,EAAvC,EAA2C;AACzC,MAAIV,IAAI,GAAG,IAAX;AACA,MAAIE,KAAK,GAAGF,IAAI,CAACE,KAAjB;AACA,MAAIH,UAAU,GAAGC,IAAI,CAACD,UAAtB;AAEAC,EAAAA,IAAI,CAACH,KAAL,GAAaA,KAAK,EAAlB,CALyC,CAOzC;AACA;;AACA,MAAIc,SAAS,GAAGhB,IAAI,CAACiB,OAAL,CAAaJ,QAAb,CAAhB,CATyC,CAWzC;;AACA,MAAIK,cAAc,GAAG;AACnBC,IAAAA,0BAA0B,EAAE,IADT;AAEnBC,IAAAA,6BAA6B,EAAE;AAFZ,GAArB,CAZyC,CAiBzC;;AACA,MAAIf,IAAI,CAACgB,cAAT,EAAyB;AACvBH,IAAAA,cAAc,CAACI,IAAf,GAAsBR,OAAO,CAACS,OAA9B;AACD,GApBwC,CAsBzC;AACA;;;AACA,WAASC,WAAT,CAAqBC,MAArB,EAA6BV,EAA7B,EAAiC;AAC/B;AACA,QAAIW,QAAQ,GAAGnB,KAAK,CAACM,QAAD,CAApB;;AACA,QAAIa,QAAJ,EAAc;AACZ,UAAI;AACF,YAAIC,GAAG,GAAGD,QAAQ,CAACD,MAAD,EAASP,cAAT,CAAlB;AACAb,QAAAA,IAAI,CAACH,KAAL,CAAW0B,IAAX,CAAgB,UAAUC,MAAV,EAAkB;AAChCC,UAAAA,MAAM,CAACC,IAAP,CAAYF,MAAZ,EAAoBG,OAApB,CAA4B,UAAUC,EAAV,EAAc;AACxCN,YAAAA,GAAG,GAAGA,GAAG,CAACO,OAAJ,CAAYD,EAAZ,EAAgBJ,MAAM,CAACI,EAAD,CAAtB,CAAN;AACD,WAFD;AAIAlB,UAAAA,EAAE,CAAC,IAAD,EAAOY,GAAP,CAAF;AACD,SAND;AAOD,OATD,CASE,OAAOQ,GAAP,EAAY;AACZpB,QAAAA,EAAE,CAACqB,sBAAsB,CAACvB,QAAD,EAAWsB,GAAX,CAAvB,CAAF;AACD;;AAED;AACD;;AAEDrC,IAAAA,EAAE,CAACuC,QAAH,CAAYxB,QAAZ,EAAsB,MAAtB,EAA8B,UAASsB,GAAT,EAAcG,GAAd,EAAkB;AAC9C,UAAIH,GAAJ,EAAS;AACP,eAAOpB,EAAE,CAACoB,GAAD,CAAT;AACD;;AAED,UAAIT,QAAQ,GAAGtB,UAAU,CAACmC,OAAX,CAAmBD,GAAnB,CAAf;;AACA,UAAIb,MAAM,CAAClB,KAAX,EAAkB;AAChBA,QAAAA,KAAK,CAACM,QAAD,CAAL,GAAkBa,QAAlB;AACD;;AAED,UAAI;AACF,YAAIC,GAAG,GAAGD,QAAQ,CAACD,MAAD,EAASP,cAAT,CAAlB;AACAb,QAAAA,IAAI,CAACH,KAAL,CAAW0B,IAAX,CAAgB,UAASC,MAAT,EAAiB;AAC/BC,UAAAA,MAAM,CAACC,IAAP,CAAYF,MAAZ,EAAoBG,OAApB,CAA4B,UAASC,EAAT,EAAa;AACvCN,YAAAA,GAAG,GAAGA,GAAG,CAACO,OAAJ,CAAYD,EAAZ,EAAgBJ,MAAM,CAACI,EAAD,CAAtB,CAAN;AACD,WAFD;AAIAlB,UAAAA,EAAE,CAAC,IAAD,EAAOY,GAAP,CAAF;AACD,SAND;AAOD,OATD,CASE,OAAOQ,GAAP,EAAY;AACZpB,QAAAA,EAAE,CAACqB,sBAAsB,CAACvB,QAAD,EAAWsB,GAAX,CAAvB,CAAF;AACD;AACF,KAtBD;AAuBD,GAnEwC,CAqEzC;;;AACA,WAASK,kBAAT,CAA6B3B,QAA7B,EAAuCa,QAAvC,EAAiDD,MAAjD,EAAyDV,EAAzD,EAA6D;AAC3DS,IAAAA,WAAW,CAACC,MAAD,EAAS,UAASU,GAAT,EAAcG,GAAd,EAAmB;AACrC,UAAIH,GAAJ,EAAS;AACP,eAAOpB,EAAE,CAACoB,GAAD,CAAT;AACD;;AAEDV,MAAAA,MAAM,CAACgB,IAAP,GAAcH,GAAd;;AAEA,UAAI;AACF,YAAIX,GAAG,GAAGD,QAAQ,CAACD,MAAD,EAASP,cAAT,CAAlB;AACAb,QAAAA,IAAI,CAACH,KAAL,CAAW0B,IAAX,CAAgB,UAAUC,MAAV,EAAkB;AAChCC,UAAAA,MAAM,CAACC,IAAP,CAAYF,MAAZ,EAAoBG,OAApB,CAA4B,UAAUC,EAAV,EAAc;AACxCN,YAAAA,GAAG,GAAGA,GAAG,CAACO,OAAJ,CAAYD,EAAZ,EAAgBJ,MAAM,CAACI,EAAD,CAAtB,CAAN;AACD,WAFD;AAIAlB,UAAAA,EAAE,CAAC,IAAD,EAAOY,GAAP,CAAF;AACD,SAND;AAOD,OATD,CASE,OAAOQ,GAAP,EAAY;AACZpB,QAAAA,EAAE,CAACqB,sBAAsB,CAACvB,QAAD,EAAWsB,GAAX,CAAvB,CAAF;AACD;AACF,KAnBU,CAAX;AAoBD;;AAED,MAAIO,MAAM,GAAG5B,OAAO,CAAC4B,MAArB,CA7FyC,CA+FzC;AACA;;AACA,MAAIA,MAAM,KAAKC,SAAX,IAAwB7B,OAAO,CAAC8B,QAAhC,IAA4C9B,OAAO,CAAC8B,QAAR,CAAiB,cAAjB,CAAhD,EAAkF;AAChFF,IAAAA,MAAM,GAAG5B,OAAO,CAAC8B,QAAR,CAAiB,cAAjB,EAAiCF,MAA1C;AACD,GAnGwC,CAqGzC;AACA;AACA;;;AACA,MAAIA,MAAM,KAAKC,SAAX,IAAwB,CAACD,MAA7B,EAAqC;AACnC,WAAOlB,WAAW,CAACV,OAAD,EAAUC,EAAV,CAAlB;AACD;;AAED,MAAI8B,SAAS,GAAG/B,OAAO,CAAC8B,QAAR,CAAiBE,KAAjC;AAEA,MAAIC,eAAe,GAAG,GAAGC,MAAH,CAAUH,SAAV,EAAqBI,GAArB,CAAyB,UAAUC,QAAV,EAAoB;AACjE,QAAIC,SAAS,GAAGnD,IAAI,CAACoD,IAAL,CAAUF,QAAV,EAAoBR,MAAM,IAAI,QAA9B,CAAhB;;AAEA,QAAI,CAAC1C,IAAI,CAACiB,OAAL,CAAakC,SAAb,CAAL,EAA8B;AAC5BA,MAAAA,SAAS,IAAInC,SAAb;AACD;;AAED,WAAOmC,SAAP;AACD,GARqB,CAAtB;;AAUA,OAAK,IAAIE,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGN,eAAe,CAACO,MAApC,EAA4CD,CAAC,EAA7C,EAAiD;AAC/C,QAAIE,eAAe,GAAGhD,KAAK,CAACwC,eAAe,CAACM,CAAD,CAAhB,CAA3B;;AAEA,QAAIE,eAAJ,EAAqB;AACnB,aAAOf,kBAAkB,CAACO,eAAe,CAACM,CAAD,CAAhB,EAAqBE,eAArB,EAAsCzC,OAAtC,EAA+CC,EAA/C,CAAzB;AACD;AACF,GA9HwC,CAgIzC;;;AAEA,WAASqB,sBAAT,CAAiCvB,QAAjC,EAA2CsB,GAA3C,EAAgD;AAC9C;AACA,QAAI,OAAOA,GAAG,CAACqB,OAAX,KAAuB,QAA3B,EAAqC;AACnCrB,MAAAA,GAAG,CAACqB,OAAJ,GAAc3C,QAAQ,GAAG,IAAX,GAAkBsB,GAAG,CAACqB,OAApC;AACD;;AAED,WAAOrB,GAAP;AACD;;AAED,WAASsB,eAAT,CAAyB5C,QAAzB,EAAmCyB,GAAnC,EAAwC;AACtC,QAAIiB,eAAe,GAAGnD,UAAU,CAACmC,OAAX,CAAmBD,GAAnB,CAAtB;;AACA,QAAIxB,OAAO,CAACP,KAAZ,EAAmB;AACjBA,MAAAA,KAAK,CAACM,QAAD,CAAL,GAAkB0C,eAAlB;AACD;;AAEDf,IAAAA,kBAAkB,CAAC3B,QAAD,EAAW0C,eAAX,EAA4BzC,OAA5B,EAAqCC,EAArC,CAAlB;AACD;;AAED,WAAS2C,mBAAT,CAA6BC,SAA7B,EAAwC;AACtC,QAAIjC,QAAQ,GAAGiC,SAAS,CAACC,KAAV,EAAf;AAEA9D,IAAAA,EAAE,CAACuC,QAAH,CAAYX,QAAZ,EAAsB,MAAtB,EAA8B,UAASS,GAAT,EAAcG,GAAd,EAAmB;AAC/C,UAAIH,GAAJ,EAAS;AACP,YAAIO,MAAM,IAAIiB,SAAS,CAACL,MAAV,KAAqB,CAAnC,EAAsC;AACpC;AACA,iBAAOvC,EAAE,CAACoB,GAAD,CAAT;AACD;;AAED,YAAIwB,SAAS,CAACL,MAAV,GAAmB,CAAvB,EAA0B;AACxB,iBAAOI,mBAAmB,CAACC,SAAD,CAA1B;AACD;;AAED,eAAOnC,WAAW,CAACV,OAAD,EAAUC,EAAV,CAAlB;AACD;;AAED0C,MAAAA,eAAe,CAAC/B,QAAD,EAAWY,GAAX,CAAf;AACD,KAfD;AAgBD;;AAEDoB,EAAAA,mBAAmB,CAACX,eAAD,CAAnB;AACD,C,CAED;;;AACA5C,QAAQ,CAAC0D,SAAT,CAAmBtB,OAAnB,GAA6B,UAAUD,GAAV,EAAe;AAC1C,MAAI,OAAOA,GAAP,KAAe,QAAnB,EAA6B;AAC3B,WAAOA,GAAP;AACD;;AAED,MAAIZ,QAAQ,GAAG,KAAKtB,UAAL,CAAgBmC,OAAhB,CAAwBD,GAAxB,CAAf;AACA,SAAO,UAAUb,MAAV,EAAkB;AACvB,WAAOC,QAAQ,CAACD,MAAD,EAAS;AACtBqC,MAAAA,OAAO,EAAErC,MAAM,CAACsC,YADM;AAEtBC,MAAAA,QAAQ,EAAE,IAFY;AAGtB1C,MAAAA,IAAI,EAAE;AAHgB,KAAT,CAAf;AAKD,GAND;AAOD,CAbD;;AAeAnB,QAAQ,CAAC0D,SAAT,CAAmBI,cAAnB,GAAoC,YAAY;AAC9C,OAAK7D,UAAL,CAAgB6D,cAAhB,CAA+BC,KAA/B,CAAqC,KAAK9D,UAA1C,EAAsD+D,SAAtD;AACD,CAFD;;AAIAhE,QAAQ,CAAC0D,SAAT,CAAmBO,eAAnB,GAAqC,YAAY;AAC/C,OAAKhE,UAAL,CAAgBgE,eAAhB,CAAgCF,KAAhC,CAAsC,KAAK9D,UAA3C,EAAuD+D,SAAvD;AACD,CAFD;;AAIAhE,QAAQ,CAAC0D,SAAT,CAAmBQ,gBAAnB,GAAsC,UAAUC,SAAV,EAAqB1C,IAArB,EAA2B;AAC/D,MAAIxB,UAAU,GAAG,KAAKA,UAAtB;;AAEA,MAAImE,QAAQ,GAAG,UAASC,QAAT,EAAmB5C,IAAnB,EAAyB;AACtC,QAAI6C,eAAe,GAAG,gBAAgBC,IAAhB,CAAqBF,QAArB,CAAtB;;AAEA,QAAI,CAACC,eAAL,EAAsB;AACpB,aAAO7C,IAAI,CAAC,IAAD,CAAX;AACD;;AAED9B,IAAAA,EAAE,CAACuC,QAAH,CAAYmC,QAAZ,EAAsB,MAAtB,EAA8B,UAASrC,GAAT,EAAcb,IAAd,EAAoB;AAChD,UAAI,CAACa,GAAL,EAAU;AACR,YAAIwC,GAAG,GAAG3E,IAAI,CAACiB,OAAL,CAAauD,QAAb,CAAV;AACA,YAAII,YAAY,GAAG5E,IAAI,CAAC6E,QAAL,CAAcP,SAAd,EAAyBE,QAAzB,EAChBM,KADgB,CACV,CADU,EACP,CAAEH,GAAG,CAACrB,MADC,EACQpB,OADR,CACgB,OADhB,EACyB,GADzB,EAEhBA,OAFgB,CAER,KAFQ,EAED,GAFC,CAAnB;AAGA9B,QAAAA,UAAU,CAACgE,eAAX,CAA2BQ,YAA3B,EAAyCtD,IAAzC;AACD;;AAEDM,MAAAA,IAAI,CAACO,GAAD,CAAJ;AACD,KAVD;AAWD,GAlBD;;AAoBAlC,EAAAA,IAAI,CAACqE,SAAD,CAAJ,CAAgBS,EAAhB,CAAmB,MAAnB,EAA2B,UAASC,IAAT,EAAeC,IAAf,EAAqBC,IAArB,EAA2B;AACpDX,IAAAA,QAAQ,CAACvE,IAAI,CAACoD,IAAL,CAAU4B,IAAV,EAAgBC,IAAI,CAACE,IAArB,CAAD,EAA6BD,IAA7B,CAAR;AACD,GAFD,EAEGH,EAFH,CAEM,KAFN,EAEanD,IAAI,IAAI,YAAW,CAAE,CAFlC;AAID,CA3BD;;AA6BAzB,QAAQ,CAAC0D,SAAT,CAAmBuB,mBAAnB,GAAyC,UAASD,IAAT,EAAeE,EAAf,EAAmB;AAC1D,MAAIhF,IAAI,GAAG,IAAX;AACAA,EAAAA,IAAI,CAACD,UAAL,CAAgB6D,cAAhB,CAA+BkB,IAA/B,EAAqC,YAAW;AAC9C,WAAO9E,IAAI,CAACH,KAAL,CAAWoF,OAAX,CAAmBD,EAAnB,EAAuBlB,SAAvB,CAAP;AACD,GAFD;AAGD,CALD;;AAOAhE,QAAQ,CAAC0D,SAAT,CAAmB0B,oBAAnB,GAA0C,UAASC,GAAT,EAAc;AACtD;AACA,OAAKnE,cAAL,GAAsB,IAAtB;;AAEAmE,EAAAA,GAAG,CAACC,MAAJ,GAAc,UAASA,MAAT,EAAiB;AAC7B,WAAO,UAASC,IAAT,EAAe5E,OAAf,EAAwB6E,QAAxB,EAAkC;AACvC,UAAI,OAAO7E,OAAP,KAAmB,UAAvB,EAAmC;AACjC6E,QAAAA,QAAQ,GAAG7E,OAAX;AACAA,QAAAA,OAAO,GAAG,EAAV;AACD,OAJsC,CAMvC;;;AACAA,MAAAA,OAAO,CAACS,OAAR,GAAkBT,OAAO,CAACS,OAAR,IAAmB,EAArC;;AACA,WAAK,IAAIqE,GAAT,IAAgB,KAAKnE,MAArB,EAA6B;AAC3BX,QAAAA,OAAO,CAACS,OAAR,CAAgBqE,GAAhB,IAAuB,KAAKnE,MAAL,CAAYmE,GAAZ,CAAvB;AACD;;AAED,aAAOH,MAAM,CAACI,IAAP,CAAY,IAAZ,EAAkBH,IAAlB,EAAwB5E,OAAxB,EAAiC6E,QAAjC,CAAP;AACD,KAbD;AAcD,GAfY,CAeVH,GAAG,CAACC,MAfM,CAAb;AAgBD,CApBD;;AAsBAK,MAAM,CAACC,OAAP,GAAiB,IAAI5F,QAAJ,EAAjB;;AACA2F,MAAM,CAACC,OAAP,CAAezF,MAAf,GAAwB,UAASF,UAAT,EAAqB;AAC3C,SAAO,IAAID,QAAJ,CAAaC,UAAb,CAAP;AACD,CAFD","sourcesContent":["var fs = require('fs');\nvar path = require('path');\nvar walk = require('walk').walk;\n\nvar async = require('./async');\n\nfunction Instance(handlebars) {\n  if (!(this instanceof Instance)) {\n    return new Instance(handlebars);\n  }\n\n  // expose handlebars, allows users to use their versions\n  // by overriding this early in their apps\n  var self = this;\n\n  self.handlebars = handlebars || require('handlebars').create();\n\n  // cache for templates, express 3.x doesn't do this for us\n  self.cache = {};\n\n  self.__express = middleware.bind(this);\n\n  // DEPRECATED, kept for backwards compatibility\n  self.SafeString = this.handlebars.SafeString;\n  self.Utils = this.handlebars.Utils;\n};\n\n// express 3.x template engine compliance\nfunction middleware(filename, options, cb) {\n  var self = this;\n  var cache = self.cache;\n  var handlebars = self.handlebars;\n\n  self.async = async();\n\n  // grab extension from filename\n  // if we need a layout, we will look for one matching out extension\n  var extension = path.extname(filename);\n\n  // Default handlebars runtime options\n  var handlebarsOpts = {\n    allowProtoMethodsByDefault: true,\n    allowProtoPropertiesByDefault: true\n  }\n\n  // If passing the locals as data, create the handlebars options object now\n  if (self.__localsAsData) {\n    handlebarsOpts.data = options._locals\n  }\n\n  // render the original file\n  // cb(err, str)\n  function render_file(locals, cb) {\n    // cached?\n    var template = cache[filename];\n    if (template) {\n      try {\n        var res = template(locals, handlebarsOpts)\n        self.async.done(function (values) {\n          Object.keys(values).forEach(function (id) {\n            res = res.replace(id, values[id])\n          })\n\n          cb(null, res)\n        })\n      } catch (err) {\n        cb(prependFilenameToError(filename, err))\n      }\n\n      return\n    }\n\n    fs.readFile(filename, 'utf8', function(err, str){\n      if (err) {\n        return cb(err);\n      }\n\n      var template = handlebars.compile(str);\n      if (locals.cache) {\n        cache[filename] = template;\n      }\n\n      try {\n        var res = template(locals, handlebarsOpts);\n        self.async.done(function(values) {\n          Object.keys(values).forEach(function(id) {\n            res = res.replace(id, values[id]);\n          });\n\n          cb(null, res);\n        });\n      } catch (err) {\n        cb(prependFilenameToError(filename, err))\n      }\n    });\n  }\n\n  // render with a layout\n  function render_with_layout (filename, template, locals, cb) {\n    render_file(locals, function(err, str) {\n      if (err) {\n        return cb(err);\n      }\n\n      locals.body = str;\n\n      try {\n        var res = template(locals, handlebarsOpts)\n        self.async.done(function (values) {\n          Object.keys(values).forEach(function (id) {\n            res = res.replace(id, values[id])\n          })\n\n          cb(null, res)\n        })\n      } catch (err) {\n        cb(prependFilenameToError(filename, err))\n      }\n    });\n  }\n\n  var layout = options.layout;\n\n  // user did not specify a layout in the locals\n  // check global layout state\n  if (layout === undefined && options.settings && options.settings['view options']) {\n    layout = options.settings['view options'].layout;\n  }\n\n  // user explicitly request no layout\n  // either by specifying false for layout: false in locals\n  // or by settings the false view options\n  if (layout !== undefined && !layout) {\n    return render_file(options, cb);\n  }\n\n  var view_dirs = options.settings.views;\n\n  var layout_filename = [].concat(view_dirs).map(function (view_dir) {\n    var view_path = path.join(view_dir, layout || 'layout');\n\n    if (!path.extname(view_path)) {\n      view_path += extension;\n    }\n\n    return view_path;\n  });\n\n  for (var i = 0; i < layout_filename.length; i++) {\n    var layout_template = cache[layout_filename[i]]\n\n    if (layout_template) {\n      return render_with_layout(layout_filename[i], layout_template, options, cb)\n    }\n  }\n\n  // TODO check if layout path has .hbs extension\n\n  function prependFilenameToError (filename, err) {\n    // prepend to the message\n    if (typeof err.message === 'string') {\n      err.message = filename + ': ' + err.message\n    }\n\n    return err\n  }\n\n  function cacheAndCompile(filename, str) {\n    var layout_template = handlebars.compile(str);\n    if (options.cache) {\n      cache[filename] = layout_template;\n    }\n\n    render_with_layout(filename, layout_template, options, cb)\n  }\n\n  function tryReadFileAndCache(templates) {\n    var template = templates.shift();\n\n    fs.readFile(template, 'utf8', function(err, str) {\n      if (err) {\n        if (layout && templates.length === 0) {\n          // Only return error if user explicitly asked for layout.\n          return cb(err);\n        }\n\n        if (templates.length > 0) {\n          return tryReadFileAndCache(templates);\n        }\n\n        return render_file(options, cb);\n      }\n\n      cacheAndCompile(template, str);\n    });\n  }\n\n  tryReadFileAndCache(layout_filename);\n}\n\n// express 2.x template engine compliance\nInstance.prototype.compile = function (str) {\n  if (typeof str !== 'string') {\n    return str;\n  }\n\n  var template = this.handlebars.compile(str);\n  return function (locals) {\n    return template(locals, {\n      helpers: locals.blockHelpers,\n      partials: null,\n      data: null\n    });\n  };\n};\n\nInstance.prototype.registerHelper = function () {\n  this.handlebars.registerHelper.apply(this.handlebars, arguments);\n};\n\nInstance.prototype.registerPartial = function () {\n  this.handlebars.registerPartial.apply(this.handlebars, arguments);\n};\n\nInstance.prototype.registerPartials = function (directory, done) {\n  var handlebars = this.handlebars;\n\n  var register = function(filepath, done) {\n    var isValidTemplate = /\\.(html|hbs)$/.test(filepath);\n\n    if (!isValidTemplate) {\n      return done(null);\n    }\n\n    fs.readFile(filepath, 'utf8', function(err, data) {\n      if (!err) {\n        var ext = path.extname(filepath);\n        var templateName = path.relative(directory, filepath)\n          .slice(0, -(ext.length)).replace(/[ -]/g, '_')\n          .replace(/\\\\/g, '/')\n        handlebars.registerPartial(templateName, data);\n      }\n\n      done(err);\n    });\n  };\n\n  walk(directory).on('file', function(root, stat, next) {\n    register(path.join(root, stat.name), next);\n  }).on('end', done || function() {});\n\n};\n\nInstance.prototype.registerAsyncHelper = function(name, fn) {\n  var self = this;\n  self.handlebars.registerHelper(name, function() {\n    return self.async.resolve(fn, arguments);\n  });\n};\n\nInstance.prototype.localsAsTemplateData = function(app) {\n  // Set a flag to indicate we should pass locals as data\n  this.__localsAsData = true;\n\n  app.render = (function(render) {\n    return function(view, options, callback) {\n      if (typeof options === \"function\") {\n        callback = options;\n        options = {};\n      }\n\n      // Mix response.locals (options._locals) with app.locals (this.locals)\n      options._locals = options._locals || {};\n      for (var key in this.locals) {\n        options._locals[key] = this.locals[key];\n      }\n\n      return render.call(this, view, options, callback);\n    };\n  })(app.render);\n};\n\nmodule.exports = new Instance();\nmodule.exports.create = function(handlebars) {\n  return new Instance(handlebars);\n};\n"]},"metadata":{},"sourceType":"script"}